{% extends 'base_design.html' %}
{% load wagtailcore_tags wagtailimages_tags %}

{% block content %}

    <div class="container mt-5 mb-5">
        <div class="text-center">
            <h1>{{ page.design_name }}</h1>
        </div>

        <div class="text-center">
            {% image page.design_image original as img %}
            <img src="{{img.url}}" class="img-fluid" alt="{{img.alt}}" style="mix-blend-mode: multiply"/>
        </div>

        {# Add streamfield blocks to welcome page. #}
        {% for block in page.design_description %}
            {% include_block block %}
        {% endfor %}


        {# Add design parameter input form. #}
        <div class="text-center">
            <h3>Design Parameters</h3>
        </div>
        <form method="POST" id="generateRecommendedComponents">
            {% csrf_token %}
            <fieldset>
            {% for parameter in page.design_params.all %}
                <div class="form-group">
                    <label for="design_parameter_{{parameter.abbreviation}}">{{parameter}} in {{parameter.units}}</label>
                    <input type="number" step="0.01" class="form-control" id="design_parameter_{{parameter.abbreviation}}" 
                            name="design_parameter_{{parameter.abbreviation}}"
                            placeholder="Enter value for {{parameter}} in {{parameter.units}}." required>
                </div>
            {% endfor %}
            
            <input type="hidden" name="generateRecommendedComponents">
            <input type="submit" class="btn btn-outline-primary" value="Generate Recommended Components">
            </fieldset>
        </form>

        {# Add recommended components output form. #}
        <div class="text-center">
            <h3>Recommended Components</h3>
        </div>
        <form method="GET" id="recommendedComponents">
            {% csrf_token %}
            <fieldset>
            {% for component in page.recommended_components.all %}
                <div class="form-group">
                    <label for="rec_component_{{component.abbreviation}}">{{component.abbreviation}} in {{component.units}}</label>
                    <big class="form-text">{{component.equation}}</big>
                    <input readOnly="" class="form-control" id="rec_component_{{component.abbreviation}}" 
                            name="rec_component_{{component.abbreviation}}"
                            placeholder="Generate recommended components to view results.">
                </div>
            {% endfor %}
            </fieldset>
        </form>

        {# Add selected components input form. #}
        <div class="text-center">
            <h3>Selected Components</h3>
        </div>
        <form method="POST" id="generateConverterAnalysis">
            {% csrf_token %}
            <fieldset>
            {% for sel_component in page.selected_components.all %}
                <div class="form-group">
                    <label for="sel_component_{{sel_component.abbreviation}}">{{sel_component.abbreviation}} in {{sel_component.units}}</label>
                    <input type="number" step="0.01" class="form-control" id="sel_component_{{sel_component.abbreviation}}" 
                        name="sel_component_{{sel_component.abbreviation}}" 
                        placeholder="Enter value for {{sel_component.abbreviation}}." required>
                </div>
            {% endfor %}

            <input type="hidden" name="generateConverterAnalysis">
            <input type="submit" class="btn btn-outline-primary" 
                    value="Generate Converter Analysis" id="generateConverterButton">
            </fieldset>
        </form>

        {# Add design equations output form. #}
        <div class="text-center">
            <h3>Converter Analysis</h3>
        </div>
        <form id="generateOpenLoopTransfers" method="POST">
            {% csrf_token %}
            <fieldset>
            {% for equation in page.design_equations.all %}
                <div class="form-group">
                    <label for="design_equation_{{equation.description}}">{{equation.description}}</label>
                    <big class="form-text">{{equation.equation}}</big>
                    <input readOnly="" class="form-control" id="design_equation_{{component}}" placeholder="Generate converter analysis to view results." required>
                </div>
            {% endfor %}

            <button type="submit" class="btn btn-outline-primary">
                Generate Open Loop Transfer Functions
            </button>
            </fieldset>
        </form>
    </div>

{% endblock %}

{% block extra_js %}

<script type="text/javascript">

(function($) {
    $.fn.genComponents = function() {
        this.submit(function(event) {
            event.preventDefault();
            var form = $(this);

            //Remove "invalid" class from previously 
            //invalid submissions.
            for(let i = 0; i < form[0].length; i++){
                let input = form[0][i]
                if (input.id){
                    $("#".concat(input.id)).removeClass("invalid");
                }
            }
            $.ajax({
                type: form.attr('method'),
                url: form.attr('action'),
                data: form.serialize(),
                success: function(json){
                    //Update recommended components with recommended values
                    //for design.
                    for (let key in json){
                        document.getElementById(key).value = json[key];
                    }
                    $("#recommendedComponents").addClass("success-border");
                    setTimeout(function(){
                        $("#recommendedComponents").removeClass("success-border");
                    }, 1000);
                },
                error: function(json){
                    let jsonErrors = $.parseJSON(json.responseText)

                    for (let key in jsonErrors){
                        $("#".concat(key)).addClass("invalid");
                    }
                }
            });
        });
        return this;
    }
})(jQuery)

$(function() {
    $('#generateRecommendedComponents').genComponents();
});

(function($) {
    $.fn.genAnalysis = function() {
        this.submit(function(event) {
            event.preventDefault();
            var form = $(this);

            $.ajax({
                type: form.attr('method'),
                url: form.attr('action'),
                data: form.serialize(),
                success: function(json){

                },
                error: function(json){

                }
            });
        });
        return this;
    }
})(jQuery)

$(function() {
    $('#generateConverterAnalysis').genAnalysis();
});

</script>

{% endblock %}

{% block extra_css %}

<style>
.success-border{
    border-style: solid;
    border-color: green;
    border-width: 1px;
    transition-timing-function: ease-in-out;
    -webkit-transition: border-color 0.5s; /* Safari */
    transition: border-color 0.5s;
}

.invalid{
    border-style: solid;
    border-color: red;
    border-width: 1px;
}
</style>

{% endblock %}